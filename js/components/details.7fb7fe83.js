import{getAnimeDetails,getAnimeCharacters,getAnimeStaff,getAnimeInfo,getRandomAnime}from"../api.0fccbd54.js";import{initFlashcardHover}from"../main.5a6e8161.js";import{showLoader,hideLoader,loadCSS,load404}from"../pages.53b77682.js";import{createFlashcard}from"./UIs.036b2cc4.js";export async function loadDetailsPage(a=null){console.log(`Loading Details for anime ID: ${a}`),loadCSS("./css/details.c0270408.css"),document.getElementById("navhome").style.color="#ddd",document.getElementById("navsearch").style.color="#ddd";const s=document.getElementById("content");s.innerHTML="",document.getElementById("randomDiv").style.display="none",showLoader();try{const n="random"===a,e=n?await getRandomAnime():await getAnimeDetails(a);if(!e||!e.mal_id)throw new Error("Anime data not found.");const i=`#/details-${a=e.mal_id}`;n&&history.replaceState(null,null,i);let t=null,l=null;window.location.hash===i&&([t,l]=await Promise.all([getAnimeCharacters(a),getAnimeStaff(a)]));const c=[...(e.title_synonyms||[]).map(a=>`<li>${a}</li>`),...(e.titles||[]).map(a=>`<li>${a.type}: ${a.title}</li>`)].join(""),r=e.genres&&e.genres.length>0?`\n        <div class="details-genres-inner">\n            <h2 class="genres-header">Genres</h2>\n            <div class="details-genres-list">\n                ${e.genres.map(a=>`<span class="genre-tag">${a.name}</span>`).join("")}\n            </div>\n        </div>\n      `:"",d=e.season?`${e.season.charAt(0).toUpperCase()+e.season.slice(1)}`:"N/A",o=e.year||"N/A",v=e.trailer?.youtube_id?`\n        <div class="details-trailer">\n            <h2>Trailer</h2>\n            <div class="trailer-container">\n              <iframe \n                  src="https://www.youtube.com/embed/${e.trailer.youtube_id}?rel=0" \n                  frameborder="0"\n                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope;" \n                  allowfullscreen>\n              </iframe>\n            </div>\n        </div>\n        `:"",p='<div id="relations-container"></div>',m=`\n        <div class="details-stats hero-stats">\n            <div class="stat-box">\n                <h3>Score</h3>\n                <p class="stat-value-large">${e.score?`‚≠ê ${e.score}`:"N/A"}</p>\n            </div>\n            <div class="stat-box">\n                <h3>Popularity</h3>\n                <p class="stat-value-large">#${e.popularity||"N/A"}</p>\n            </div>\n            <div class="stat-box">\n                <h3>Members</h3>\n                <p class="stat-value-large">${e.members?.toLocaleString()||"N/A"}</p>\n            </div>\n            <div class="stat-box">\n                <h3>Rank</h3>\n                <p class="stat-value-large">#${e.rank||"N/A"}</p>\n            </div>\n        </div>\n    `,g=`\n      <div class="details-genres-inner">\n          <h2 class="genres-header">Producers</h2>\n          <div class="details-genres-list">\n              ${e.producers&&e.producers.length>0?e.producers.map(a=>`<span class="genre-tag">${a.name}</span>`).join(""):'<span class="genre-tag is-na">N/A</span>'}\n          </div>\n      </div>\n      <div class="details-genres-inner">\n          <h2 class="genres-header">Licensors</h2>\n          <div class="details-genres-list">\n              ${e.licensors&&e.licensors.length>0?e.licensors.map(a=>`<span class="genre-tag">${a.name}</span>`).join(""):'<span class="genre-tag is-na">N/A</span>'}\n          </div>\n      </div>\n      <div class="details-genres-inner">\n          <h2 class="genres-header">Studios</h2>\n          <div class="details-genres-list">\n              ${e.studios&&e.studios.length>0?e.studios.map(a=>`<span class="genre-tag">${a.name}</span>`).join(""):'<span class="genre-tag is-na">N/A</span>'}\n          </div>\n      </div>\n      <div class="themes-section">\n          <h4>Opening Themes</h4>\n          <ul>${e.theme?.openings&&e.theme.openings.length>0?e.theme.openings.map(a=>`<li>${a}</li>`).join(""):"<li>No opening themes found.</li>"}</ul>\n          <h4>Ending Themes</h4>\n          <ul>${e.theme?.endings&&e.theme.endings.length>0?e.theme.endings.map(a=>`<li>${a}</li>`).join(""):"<li>No ending themes found.</li>"}</ul>\n      </div>\n      <div class="links-section">\n          <div class="external-links">\n              <h4>External Links</h4>\n              <div class="links-container">\n                  ${e.external&&e.external.length>0?e.external.map(a=>`<a href="${a.url}" target="_blank" class="link-button"><i class="fa-solid fa-arrow-up-right-from-square"></i>${a.name}</a>`).join(""):"<p>No external links available.</p>"}\n              </div>\n          </div>\n          <div class="streaming-platforms">\n              <h4>Streaming Platforms</h4>\n              <div class="links-container">\n                  ${e.streaming&&e.streaming.length>0?e.streaming.map(a=>`<a href="${a.url}" target="_blank" class="link-button"><i class="fas fa-play-circle"></i>${a.name}</a>`).join(""):"<p>No streaming links available.</p>"}\n              </div>\n          </div>\n      </div>\n    `,h=t&&t.length>0?`<div class="character-grid">${t.map(a=>{const s=a.character.images.webp.image_url;return`\n        <div class="character-card">\n            ${s.includes("questionmark")?'<div class="placeholder-icon"><i class="fas fa-user"></i></div>':`<img src="${s}" loading="lazy" alt="${a.character.name}">`}\n            <div class="character-info">\n                <h5>${a.character.name}</h5>\n                <p>${a.role}</p>\n                ${a.voice_actors&&a.voice_actors.length>0?`<p class="voice-actor"><b>Voice Actor:</b> ${a.voice_actors[0].person.name} (${a.voice_actors[0].language})</p>`:""}\n            </div>\n        </div>`}).join("")}</div>`:"<p>No character information available.</p>",f=l&&l.length>0?`<div class="staff-grid">${l.map(a=>{const s=a.person.images.jpg.image_url;return`\n        <div class="staff-card">\n            ${s.includes("questionmark")?'<div class="placeholder-icon"><i class="fas fa-user-tie"></i></div>':`<img src="${s}" loading="lazy" alt="${a.person.name}">`}\n            <div class="staff-info">\n                <h5>${a.person.name}</h5>\n                <p>${a.positions.join(", ")}</p>\n            </div>\n        </div>`}).join("")}</div>`:"<p>No staff information available.</p>",u=`\n      <div class="details-hero-wrapper">\n          <h1>${e.title_english||e.title}</h1>\n          <div class="details-hero">\n            <div class="details-poster-group">\n              <div class="details-poster">\n                <img src="${e.images?.webp?.large_image_url||"./placeholder.png"}" alt="${e.title||"No Title"}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"/>\n                <div class="placeholder-icon" style="display: none;"><i class="fas fa-question-circle"></i></div>\n              </div>\n          </div>\n          <div class="details-info">\n            ${m}\n            <h2 class="synopsis-header">Synopsis</h2>\n            <p class="details-synopsis">${e.synopsis||"No synopsis available."}</p>\n          </div>\n        </div>\n      </div>\n      <div class="details-container">\n        <div class="quick-facts-table">\n            <div class="fact-item"><span class="fact-label">Type:</span><span class="fact-value">${e.type||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Episodes:</span><span class="fact-value">${e.episodes||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Status:</span><span class="fact-value">${e.status||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Aired:</span><span class="fact-value">${e.aired?.string||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Season:</span><span class="fact-value">${d}</span></div>\n            <div class="fact-item"><span class="fact-label">Year:</span><span class="fact-value">${o}</span></div>\n            <div class="fact-item"><span class="fact-label">Rating:</span><span class="fact-value">${e.rating||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Source:</span><span class="fact-value">${e.source||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Scored By:</span><span class="fact-value">${e.scored_by?.toLocaleString()||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Duration:</span><span class="fact-value">${e.duration||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Favorites:</span><span class="fact-value">${e.favorites?.toLocaleString()||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Official Source:</span><span class="fact-value"><a href="${e.url||"#"}" target="_blank" class="source-link">MyAnimeList</a></span></div>\n        </div>\n\n        <nav class="details-nav">\n          <div class="details-nav-item active" data-target="overview">Overview</div>\n          <div class="details-nav-item" data-target="relations">Relations</div>\n          <div class="details-nav-item" data-target="production">Production</div>\n          <div class="details-nav-item" data-target="characters">Characters</div>\n          <div class="details-nav-item" data-target="staff">Staff</div>\n        </nav>\n\n        <div id="overview" class="details-section active">\n            <div class="details-titles-box">\n              <h2>Also Known As: </h4>\n              <ul class="titles-list">${c}</ul>\n            </div>\n            ${r}\n            <h2>Background</h2>\n            <p>${e.background||"No background information available."}</p>\n        </div>\n\n        <div id="relations" class="details-section">\n          ${p}\n        </div>\n\n        <div id="production" class="details-section">\n          ${g}\n        </div>\n\n        <div id="characters" class="details-section">\n          ${h}\n        </div>\n\n        <div id="staff" class="details-section">\n          ${f}\n        </div>\n\n        ${v}\n      </div>\n    `;window.location.hash===i&&(s.innerHTML=u,initTabbedNavigation(),loadRelations(e.relations,a))}catch(s){console.error("Failed to load anime details:",s),load404(`details-${a}`)}finally{window.location.hash===`#/details-${a}`&&(hideLoader(),document.getElementById("randomDiv").style.display="none")}}async function loadRelations(a,s){const n=document.getElementById("relations-container");if(!a||0===a.length)return void(n.innerHTML="<p>No related anime found.</p>");const e=`#/details-${s}`;if(window.location.hash===e)for(const s of a){const a=document.createElement("div");a.className="relation-group";const i=document.createElement("h4");i.className="relation-group-title",i.textContent=s.relation,a.appendChild(i);const t=document.createElement("div");t.className="gridGallery",t.style.justifyContent="none",a.appendChild(t);for(const a of s.entry)if("anime"===a.type)try{const s=window.location.hash===e?await getAnimeInfo(a.mal_id):null;s&&(t.innerHTML+=createFlashcard(s,"top-rated"))}catch(s){console.error(`Failed to fetch info for anime ID: ${a.mal_id}`,s),t.innerHTML+=createFallbackCard(a)}else t.innerHTML+=createFallbackCard(a);n.appendChild(a)}initFlashcardHover()}function createFallbackCard(a){return`\n    <a href="${a.url}" target="_blank" class="relation-card-fallback">\n      <span class="relation-card-title">${a.name}</span>\n      <span class="relation-card-type">${a.type}</span>\n    </a>\n  `}function initTabbedNavigation(){const a=document.querySelectorAll(".details-nav-item"),s=document.querySelectorAll(".details-section");a.forEach(n=>{n.addEventListener("click",()=>{a.forEach(a=>a.classList.remove("active")),s.forEach(a=>a.classList.remove("active")),n.classList.add("active");const e=n.getAttribute("data-target"),i=document.getElementById(e);i&&i.classList.add("active")})})}